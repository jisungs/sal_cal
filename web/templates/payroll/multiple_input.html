{% extends "base.html" %}

{% block title %}급여명세서 다중 직원 직접 입력{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">✏️ 급여명세서 다중 직원 직접 입력</h3>
            </div>
            <div class="card-body">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <form method="POST" id="multiplePayrollForm">
                    
                    <!-- 공통 정보 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="period" class="form-label">지급 기간</label>
                                <input type="text" class="form-control" id="period" name="period" 
                                       placeholder="2025-01" pattern="\d{4}-\d{2}" required>
                                <div class="form-text">형식: YYYY-MM</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">출력 형식</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="output_format" 
                                               id="format_excel" value="excel">
                                        <label class="form-check-label" for="format_excel">엑셀</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="output_format" 
                                               id="format_pdf" value="pdf">
                                        <label class="form-check-label" for="format_pdf">PDF</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="output_format" 
                                               id="format_both" value="both" checked>
                                        <label class="form-check-label" for="format_both">둘 다</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label class="form-label mb-3">디자인 선택</label>
                                <input type="hidden" name="design_name" id="design_name" value="default">
                                <div class="row g-3" id="design-cards">
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card design-card h-100" data-design="default" style="cursor: pointer; border: 2px solid #dee2e6; transition: all 0.3s;">
                                            <div class="card-body text-center">
                                                <div class="mb-2">
                                                    <input type="radio" name="design_radio" value="default" id="design_default_multiple" checked style="display: none;">
                                                    <div style="font-size: 2.5rem; color: #6c757d;">📄</div>
                                                </div>
                                                <h6 class="card-title mb-1">기본 디자인</h6>
                                                <p class="card-text small text-muted mb-0">기존 방식과 동일</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card design-card h-100" data-design="template_sample1" style="cursor: pointer; border: 2px solid #dee2e6; transition: all 0.3s;">
                                            <div class="card-body text-center">
                                                <div class="mb-2">
                                                    <input type="radio" name="design_radio" value="template_sample1" id="design_template_sample1_multiple" style="display: none;">
                                                    <div style="font-size: 2.5rem; color: #fd7e14;">📊</div>
                                                </div>
                                                <h6 class="card-title mb-1">템플릿 1</h6>
                                                <p class="card-text small text-muted mb-0">급여명세서 템플릿</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card design-card h-100" data-design="template_sample2" style="cursor: pointer; border: 2px solid #dee2e6; transition: all 0.3s;">
                                            <div class="card-body text-center">
                                                <div class="mb-2">
                                                    <input type="radio" name="design_radio" value="template_sample2" id="design_template_sample2_multiple" style="display: none;">
                                                    <div style="font-size: 2.5rem; color: #dc3545;">📋</div>
                                                </div>
                                                <h6 class="card-title mb-1">템플릿 2</h6>
                                                <p class="card-text small text-muted mb-0">임금명세서 템플릿</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text mt-2">원하는 디자인 카드를 클릭하여 선택하세요.</div>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                    // 디자인 카드 선택 기능 (다중 입력 폼용)
                    document.addEventListener('DOMContentLoaded', function() {
                        const designCards = document.querySelectorAll('#design-cards .design-card');
                        const hiddenInput = document.getElementById('design_name');
                        
                        // 초기 선택 상태 설정
                        const defaultCard = document.querySelector('#design-cards [data-design="default"]');
                        if (defaultCard) {
                            defaultCard.style.borderColor = '#0d6efd';
                            defaultCard.style.backgroundColor = '#f0f7ff';
                        }
                        
                        designCards.forEach(card => {
                            card.addEventListener('click', function() {
                                const designValue = this.getAttribute('data-design');
                                
                                // 모든 카드 스타일 초기화
                                designCards.forEach(c => {
                                    c.style.borderColor = '#dee2e6';
                                    c.style.backgroundColor = '';
                                });
                                
                                // 선택된 카드 스타일 적용
                                this.style.borderColor = '#0d6efd';
                                this.style.backgroundColor = '#f0f7ff';
                                
                                // hidden input 업데이트
                                hiddenInput.value = designValue;
                                
                                // radio button 업데이트
                                const radio = this.querySelector('input[type="radio"]');
                                if (radio) {
                                    radio.checked = true;
                                }
                                
                                console.log('디자인 선택:', designValue);
                            });
                            
                            // 호버 효과
                            card.addEventListener('mouseenter', function() {
                                if (this.style.borderColor !== 'rgb(13, 110, 253)') {
                                    this.style.borderColor = '#adb5bd';
                                    this.style.transform = 'translateY(-2px)';
                                }
                            });
                            
                            card.addEventListener('mouseleave', function() {
                                if (this.style.borderColor !== 'rgb(13, 110, 253)') {
                                    this.style.borderColor = '#dee2e6';
                                    this.style.transform = '';
                                }
                            });
                        });
                    });
                    </script>
                    
                    <hr>
                    
                    <!-- 직원 목록 -->
                    <div id="employeesContainer">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">직원 정보</h5>
                            <button type="button" class="btn btn-success btn-sm" id="addEmployeeBtn">
                                ➕ 직원 추가
                            </button>
                        </div>
                        
                        <!-- 직원 입력 폼 템플릿 (숨김) -->
                        <template id="employeeTemplate">
                            <div class="employee-form card mb-3" data-employee-index="">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">직원 <span class="employee-number">1</span></h6>
                                    <button type="button" class="btn btn-danger btn-sm remove-employee-btn">
                                        🗑️ 삭제
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="mb-3">기본 정보</h6>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">이름 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control employee-name" 
                                                       name="employees[][name]" required maxlength="50">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">주민번호 앞자리 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control employee-resident-number" 
                                                       name="employees[][resident_number]" 
                                                       placeholder="123456" pattern="\d{6}" maxlength="6" required>
                                                <div class="form-text">6자리 숫자만 입력</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">입사일 <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control employee-hire-date" 
                                                       name="employees[][hire_date]" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">은행명</label>
                                                <input type="text" class="form-control employee-bank-name" 
                                                       name="employees[][bank_name]" 
                                                       placeholder="예: KB국민은행, 신한은행" maxlength="50">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">계좌번호</label>
                                                <input type="text" class="form-control employee-account-number" 
                                                       name="employees[][account_number]" 
                                                       placeholder="123-456-789012" maxlength="50">
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <h6 class="mb-3">급여 정보</h6>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">기본급 (원) <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control employee-base-salary" 
                                                       name="employees[][base_salary]" min="0" step="1000" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">부양가족수</label>
                                                <input type="number" class="form-control employee-dependents" 
                                                       name="employees[][dependents]" min="0" max="10" value="0">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">연장근무시간</label>
                                                <input type="number" class="form-control employee-overtime-hours" 
                                                       name="employees[][overtime_hours]" min="0" value="0">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">연장근무단가 (원/시간)</label>
                                                <input type="number" class="form-control employee-overtime-rate" 
                                                       name="employees[][overtime_rate]" min="0" step="1000" value="0">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">상여금 (원)</label>
                                                <input type="number" class="form-control employee-bonus" 
                                                       name="employees[][bonus]" min="0" step="1000" value="0">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">공제사항 메모</label>
                                                <textarea class="form-control employee-deduction-note" 
                                                          name="employees[][deduction_note]" rows="2" maxlength="200"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- 첫 번째 직원 폼 (기본 표시) -->
                        <div class="employee-form card mb-3" data-employee-index="0">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">직원 <span class="employee-number">1</span></h6>
                                <button type="button" class="btn btn-danger btn-sm remove-employee-btn" disabled>
                                    🗑️ 삭제
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="mb-3">기본 정보</h6>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">이름 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control employee-name" 
                                                   name="employees[0][name]" required maxlength="50">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">주민번호 앞자리 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control employee-resident-number" 
                                                   name="employees[0][resident_number]" 
                                                   placeholder="123456" pattern="\d{6}" maxlength="6" required>
                                            <div class="form-text">6자리 숫자만 입력</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">입사일 <span class="text-danger">*</span></label>
                                            <input type="date" class="form-control employee-hire-date" 
                                                   name="employees[0][hire_date]" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">은행명</label>
                                            <input type="text" class="form-control employee-bank-name" 
                                                   name="employees[0][bank_name]" 
                                                   placeholder="예: KB국민은행, 신한은행" maxlength="50">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">계좌번호</label>
                                            <input type="text" class="form-control employee-account-number" 
                                                   name="employees[0][account_number]" 
                                                   placeholder="123-456-789012" maxlength="50">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <h6 class="mb-3">급여 정보</h6>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">기본급 (원) <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control employee-base-salary" 
                                                   name="employees[0][base_salary]" min="0" step="1000" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">부양가족수</label>
                                            <input type="number" class="form-control employee-dependents" 
                                                   name="employees[0][dependents]" min="0" max="10" value="0">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">연장근무시간</label>
                                            <input type="number" class="form-control employee-overtime-hours" 
                                                   name="employees[0][overtime_hours]" min="0" value="0">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">연장근무단가 (원/시간)</label>
                                            <input type="number" class="form-control employee-overtime-rate" 
                                                   name="employees[0][overtime_rate]" min="0" step="1000" value="0">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">상여금 (원)</label>
                                            <input type="number" class="form-control employee-bonus" 
                                                   name="employees[0][bonus]" min="0" step="1000" value="0">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">공제사항 메모</label>
                                            <textarea class="form-control employee-deduction-note" 
                                                      name="employees[0][deduction_note]" rows="2" maxlength="200"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            📄 급여명세서 일괄 생성
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 입력 가이드 -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">📚 입력 가이드</h5>
            </div>
            <div class="card-body">
                <div class="accordion" id="multipleInputGuideAccordion">
                    <!-- 사용 방법 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingUsage">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapseUsage" aria-expanded="true" aria-controls="collapseUsage">
                                사용 방법
                            </button>
                        </h2>
                        <div id="collapseUsage" class="accordion-collapse collapse show" 
                             aria-labelledby="headingUsage" data-bs-parent="#multipleInputGuideAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>지급 기간과 출력 형식을 선택하세요</li>
                                    <li>"직원 추가" 버튼을 클릭하여 여러 직원을 추가할 수 있습니다</li>
                                    <li>각 직원의 필수 정보를 입력하세요 (이름, 주민번호, 입사일, 기본급)</li>
                                    <li>선택 정보는 필요에 따라 입력하세요</li>
                                    <li>불필요한 직원은 "삭제" 버튼으로 제거할 수 있습니다</li>
                                    <li>모든 정보를 입력한 후 "급여명세서 일괄 생성" 버튼을 클릭하세요</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 필수 필드 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingRequiredMultiple">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapseRequiredMultiple" aria-expanded="false" aria-controls="collapseRequiredMultiple">
                                필수 입력 항목
                            </button>
                        </h2>
                        <div id="collapseRequiredMultiple" class="accordion-collapse collapse" 
                             aria-labelledby="headingRequiredMultiple" data-bs-parent="#multipleInputGuideAccordion">
                            <div class="accordion-body">
                                <ul>
                                    <li><strong>이름</strong>: 직원의 성명 (1-50자)</li>
                                    <li><strong>주민번호 앞자리</strong>: 주민등록번호 앞 6자리 (예: 123456)</li>
                                    <li><strong>입사일</strong>: YYYY-MM-DD 형식 (예: 2024-01-01)</li>
                                    <li><strong>기본급</strong>: 월 기본급 (원 단위, 예: 3000000)</li>
                                </ul>
                                <p class="text-muted mt-2"><small>부양가족수는 기본값 0으로 설정되며, 필요시 변경할 수 있습니다.</small></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 팁 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTips">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapseTips" aria-expanded="false" aria-controls="collapseTips">
                                사용 팁
                            </button>
                        </h2>
                        <div id="collapseTips" class="accordion-collapse collapse" 
                             aria-labelledby="headingTips" data-bs-parent="#multipleInputGuideAccordion">
                            <div class="accordion-body">
                                <ul>
                                    <li>💡 여러 직원의 정보를 한 번에 입력하여 일괄 처리할 수 있습니다</li>
                                    <li>💡 첫 번째 직원은 삭제할 수 없습니다 (최소 1명 필요)</li>
                                    <li>💡 직원을 삭제하면 자동으로 번호가 재정렬됩니다</li>
                                    <li>💡 필수 정보가 누락된 직원은 자동으로 제외됩니다</li>
                                    <li>💡 엑셀 파일이 있다면 엑셀 업로드를 사용하는 것이 더 빠를 수 있습니다</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/multiple_payroll_input.js') }}"></script>
<script>
    // 현재 날짜를 기본값으로 설정
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const periodField = document.getElementById('period');
        if (periodField && !periodField.value) {
            periodField.value = `${year}-${month}`;
        }
    });
</script>
{% endblock %}

