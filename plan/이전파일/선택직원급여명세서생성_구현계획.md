# 📋 선택 직원 급여명세서 생성 기능 구현 계획

**작성일**: 2025-11-11  
**요청 사항**: 파일 미리보기에서 선택한 직원만 급여명세서 생성

---

## 📊 현재 상태 분석

### ✅ 현재 구현된 기능

1. **미리보기 트리뷰**
   - `ttk.Treeview`로 구현됨
   - 전체 직원 데이터 표시
   - 이름, 주민번호, 입사일, 기본급 컬럼 표시

2. **급여명세서 생성**
   - `generate_payroll()` 메서드로 전체 직원 처리
   - 엑셀 파일의 모든 직원에 대해 급여명세서 생성
   - 선택 기능 없음

### ❌ 현재 미구현 기능

1. **선택 기능**
   - 미리보기에서 직원 선택 기능 없음
   - 다중 선택 기능 없음
   - 선택된 항목 표시 기능 없음

2. **선택된 직원만 처리**
   - 선택된 직원만 급여명세서 생성하는 로직 없음
   - 전체 직원을 항상 처리함

---

## 🎯 구현 목표

### 주요 목표

1. **미리보기에서 직원 선택 기능**
   - **개별 선택**: 마우스 클릭으로 개별 항목 선택/해제
   - **다중 선택**: Ctrl+클릭, Shift+클릭으로 다중 선택
   - **전체 선택**: "전체 선택" 버튼으로 모든 직원 한 번에 선택
   - **전체 해제**: "전체 해제" 버튼으로 모든 선택 해제
   - 선택된 항목 시각적 표시
   - 선택 상태 실시간 표시 ("선택된 직원: N명 / 전체: M명")

2. **선택된 직원만 급여명세서 생성**
   - 선택된 직원이 있으면 선택된 직원만 처리
   - 선택된 직원이 없으면 전체 직원 처리 (기존 동작 유지)
   - 전체 선택 후 생성 시에도 선택된 직원만 처리
   - 선택 상태에 따른 명확한 피드백

---

## 📋 구현 계획

### 1. 미리보기 트리뷰 선택 기능 활성화

#### 1.1 Treeview 설정 변경

**현재 코드**:
```python
self.preview_tree = ttk.Treeview(preview_frame, columns=columns, show='headings', height=5)
```

**변경 후**:
```python
self.preview_tree = ttk.Treeview(
    preview_frame, 
    columns=columns, 
    show='headings', 
    height=5,
    selectmode='extended'  # 다중 선택 가능
)
```

#### 1.2 선택 상태 표시

- 선택된 항목 수 표시 라벨 추가
- "선택된 직원: N명" 형태로 표시

### 2. 선택된 직원 추적

#### 2.1 선택된 직원 이름 저장

- `generate_payroll()` 메서드에서 선택된 항목 확인
- 선택된 항목의 이름 추출
- 선택된 이름 목록을 기반으로 DataFrame 필터링

#### 2.2 선택 상태 확인 메서드

```python
def get_selected_employees(self):
    """선택된 직원 이름 목록 반환"""
    selected_items = self.preview_tree.selection()
    selected_names = []
    for item in selected_items:
        values = self.preview_tree.item(item, 'values')
        if values:
            name = values[0]  # 첫 번째 컬럼이 이름
            selected_names.append(name)
    return selected_names
```

### 3. 급여명세서 생성 로직 수정

#### 3.1 선택된 직원 필터링

**현재 코드**:
```python
# 각 직원별 처리
for idx, row in df.iterrows():
    # 모든 직원 처리
```

**변경 후**:
```python
# 선택된 직원 확인
selected_names = self.get_selected_employees()

# 선택된 직원이 있으면 필터링, 없으면 전체 처리
if selected_names:
    df = df[df['이름'].isin(selected_names)]
    total_employees = len(df)
    if total_employees == 0:
        raise ValueError("선택된 직원이 없습니다.")
else:
    # 선택된 직원이 없으면 전체 처리 (기존 동작)
    total_employees = len(df)

# 각 직원별 처리
for idx, row in df.iterrows():
    # 필터링된 직원만 처리
```

### 4. UI 개선

#### 4.1 선택 상태 표시 라벨

- 미리보기 프레임에 선택 상태 표시 라벨 추가
- "선택된 직원: N명" 또는 "전체 직원 처리" 표시
- 선택 상태에 따라 색상 변경 (선택됨: 파란색, 전체: 회색)

#### 4.2 선택/해제 버튼 (필수 기능)

- **"전체 선택" 버튼**: 모든 직원을 한 번에 선택
- **"전체 해제" 버튼**: 모든 선택을 해제하여 전체 처리 모드로 전환
- **개별 선택**: Treeview에서 직접 클릭하여 개별 선택/해제
- 사용자 편의성 향상

---

## 🔄 구현 단계

### 단계 1: Treeview 선택 모드 활성화
**예상 시간**: 15분

**작업 내용**:
- [ ] `selectmode='extended'` 추가
- [ ] 다중 선택 테스트

### 단계 2: 선택된 직원 추적 메서드 구현
**예상 시간**: 30분

**작업 내용**:
- [ ] `get_selected_employees()` 메서드 구현
- [ ] 선택된 항목에서 이름 추출 로직
- [ ] 빈 선택 처리

### 단계 3: 급여명세서 생성 로직 수정
**예상 시간**: 30분

**작업 내용**:
- [ ] `generate_payroll()` 메서드 수정
- [ ] 선택된 직원 필터링 로직 추가
- [ ] 선택된 직원이 없을 때 처리 (전체 처리 또는 경고)

### 단계 4: UI 개선
**예상 시간**: 45분

**작업 내용**:
- [ ] 선택 상태 표시 라벨 추가
- [ ] 선택된 직원 수 실시간 업데이트
- [ ] "전체 선택" 버튼 추가 및 구현
- [ ] "전체 해제" 버튼 추가 및 구현
- [ ] 개별 선택 기능 테스트 (마우스 클릭)
- [ ] 다중 선택 기능 테스트 (Ctrl+클릭, Shift+클릭)

### 단계 5: 테스트
**예상 시간**: 40분

**테스트 항목**:
- [ ] **개별 선택 테스트**
  - [ ] 단일 항목 클릭 선택
  - [ ] 선택된 항목 다시 클릭하여 해제
  - [ ] 다른 항목 클릭 시 선택 이동
- [ ] **다중 선택 테스트**
  - [ ] Ctrl+클릭으로 다중 선택
  - [ ] Shift+클릭으로 범위 선택
  - [ ] Ctrl+클릭으로 선택 해제
- [ ] **전체 선택/해제 테스트**
  - [ ] "전체 선택" 버튼 클릭 시 모든 항목 선택
  - [ ] "전체 해제" 버튼 클릭 시 모든 선택 해제
  - [ ] 전체 선택 후 일부 해제 가능 여부
- [ ] **선택 상태 표시 테스트**
  - [ ] 선택 상태 라벨이 실시간으로 업데이트되는지 확인
  - [ ] 전체 선택 시 "전체 선택됨" 표시 확인
  - [ ] 일부 선택 시 "선택된 직원: N명 / 전체: M명" 표시 확인
  - [ ] 선택 없을 시 "전체 직원 처리" 표시 확인
- [ ] **급여명세서 생성 테스트**
  - [ ] 선택된 직원만 급여명세서 생성 확인
  - [ ] 선택 없이 생성 시 전체 처리 확인
  - [ ] 전체 선택 후 생성 시 전체 처리 확인
  - [ ] 일부 선택 후 생성 시 선택된 직원만 처리 확인

### 단계 6: 에러 처리 및 예외 상황
**예상 시간**: 20분

**작업 내용**:
- [ ] 선택된 직원이 파일에 없을 때 처리
- [ ] 선택된 직원 이름이 중복될 때 처리
- [ ] 선택 해제 후 생성 시 처리

---

## 📝 구현 상세

### 1. Treeview 선택 모드 설정

```python
# 미리보기 트리뷰
columns = ('이름', '주민번호', '입사일', '기본급')
self.preview_tree = ttk.Treeview(
    preview_frame, 
    columns=columns, 
    show='headings', 
    height=5,
    selectmode='extended'  # 다중 선택 가능 (개별 선택, 전체 선택 모두 지원)
)
```

**선택 모드 옵션**:
- `'browse'`: 단일 선택만 가능 (기본값)
- `'extended'`: 다중 선택 가능 (Ctrl+클릭, Shift+클릭, 전체 선택 지원)
- `'none'`: 선택 불가

**선택 방식**:
- **개별 선택**: 항목을 클릭하면 해당 항목만 선택 (기존 선택 해제)
- **다중 선택 (Ctrl+클릭)**: Ctrl 키를 누른 상태에서 클릭하면 기존 선택 유지하며 추가 선택
- **범위 선택 (Shift+클릭)**: Shift 키를 누른 상태에서 클릭하면 첫 선택부터 현재까지 범위 선택
- **전체 선택**: "전체 선택" 버튼으로 모든 항목 한 번에 선택
- **전체 해제**: "전체 해제" 버튼으로 모든 선택 해제

### 2. 선택된 직원 추적 메서드

```python
def get_selected_employees(self):
    """선택된 직원 이름 목록 반환"""
    selected_items = self.preview_tree.selection()
    selected_names = []
    
    for item in selected_items:
        values = self.preview_tree.item(item, 'values')
        if values and len(values) > 0:
            name = values[0]  # 첫 번째 컬럼이 이름
            selected_names.append(name)
    
    return selected_names
```

### 3. 급여명세서 생성 로직 수정

```python
def generate_payroll(self):
    """급여명세서 생성 (백그라운드 스레드)"""
    try:
        # 진행 상태 업데이트
        self.status_label.config(text="직원 정보 읽는 중...")
        self.progress_var.set(10)
        
        # 파일 존재 확인
        file_path = self.employee_file_path.get()
        if not os.path.exists(file_path):
            raise FileNotFoundError(f"파일을 찾을 수 없습니다: {file_path}")
        
        # 파일 읽기 권한 확인
        if not os.access(file_path, os.R_OK):
            raise PermissionError(f"파일을 읽을 권한이 없습니다: {file_path}")
        
        # 엑셀 파일 읽기
        df = self.excel_handler.read_employee_data(file_path)
        
        # 선택된 직원 확인
        selected_names = self.get_selected_employees()
        
        # 선택된 직원이 있으면 필터링
        if selected_names:
            # 선택된 이름이 실제 데이터에 있는지 확인
            available_names = df['이름'].tolist()
            valid_selected = [name for name in selected_names if name in available_names]
            
            if not valid_selected:
                raise ValueError("선택된 직원이 파일에 없습니다.")
            
            # 선택된 직원만 필터링
            df = df[df['이름'].isin(valid_selected)]
            total_employees = len(df)
            
            logger.info(f"선택된 직원만 처리: {len(valid_selected)}명")
        else:
            # 선택된 직원이 없으면 전체 처리 (기존 동작)
            total_employees = len(df)
            logger.info(f"전체 직원 처리: {total_employees}명")
        
        if total_employees == 0:
            raise ValueError("처리할 직원 데이터가 없습니다.")
        
        # 출력 폴더 생성
        output_folder = self.output_folder_path.get()
        try:
            os.makedirs(output_folder, exist_ok=True)
        except PermissionError:
            raise PermissionError(f"출력 폴더를 생성할 권한이 없습니다: {output_folder}")
        
        # 출력 폴더 쓰기 권한 확인
        if not os.access(output_folder, os.W_OK):
            raise PermissionError(f"출력 폴더에 쓸 권한이 없습니다: {output_folder}")
        
        # 각 직원별 처리
        for idx, row in df.iterrows():
            # ... 기존 처리 로직 ...
```

### 4. 선택 상태 표시 UI

#### 4.1 선택 상태 라벨

```python
# 선택 상태 표시 라벨 (버튼 프레임 내부에 배치)
self.selection_status_label = ttk.Label(
    selection_btn_frame,  # 버튼 프레임 내부
    text="전체 직원 처리",
    font=("맑은 고딕", 9),
    foreground="gray"
)
self.selection_status_label.pack(side=tk.LEFT, padx=(10, 0))
```

#### 4.2 선택 변경 이벤트 핸들러

```python
# 선택 변경 이벤트 바인딩
self.preview_tree.bind('<<TreeviewSelect>>', self.on_selection_change)

def on_selection_change(self, event=None):
    """선택 변경 시 호출 (개별 선택, 전체 선택, 전체 해제 모두에서 호출)"""
    selected_names = self.get_selected_employees()
    total_items = len(self.preview_tree.get_children())
    
    if selected_names:
        selected_count = len(selected_names)
        if selected_count == total_items:
            # 전체 선택된 경우
            self.selection_status_label.config(
                text=f"전체 선택됨 ({selected_count}명)",
                foreground="green"
            )
        else:
            # 일부만 선택된 경우
            self.selection_status_label.config(
                text=f"선택된 직원: {selected_count}명 / 전체: {total_items}명",
                foreground="blue"
            )
    else:
        # 선택되지 않은 경우 (전체 처리 모드)
        self.selection_status_label.config(
            text="전체 직원 처리",
            foreground="gray"
        )
```

### 5. 선택/해제 버튼 (필수 기능)

#### 5.1 버튼 UI 추가

```python
# 선택 버튼 프레임 (미리보기 프레임 내부, 트리뷰 위에 배치)
selection_btn_frame = ttk.Frame(preview_frame)
selection_btn_frame.pack(pady=(0, 5), fill=tk.X)

ttk.Button(
    selection_btn_frame,
    text="전체 선택",
    command=self.select_all_employees,
    width=12
).pack(side=tk.LEFT, padx=5)

ttk.Button(
    selection_btn_frame,
    text="전체 해제",
    command=self.deselect_all_employees,
    width=12
).pack(side=tk.LEFT, padx=5)

# 선택 상태 표시 라벨 (버튼 옆에 배치)
self.selection_status_label = ttk.Label(
    selection_btn_frame,
    text="전체 직원 처리",
    font=("맑은 고딕", 9),
    foreground="gray"
)
self.selection_status_label.pack(side=tk.LEFT, padx=(10, 0))
```

#### 5.2 전체 선택 메서드

```python
def select_all_employees(self):
    """모든 직원 선택"""
    all_items = self.preview_tree.get_children()
    if not all_items:
        return
    
    # 모든 항목 선택
    for item in all_items:
        self.preview_tree.selection_add(item)
    
    # 선택 상태 업데이트
    self.on_selection_change()
    logger.info(f"전체 직원 선택: {len(all_items)}명")
```

#### 5.3 전체 해제 메서드

```python
def deselect_all_employees(self):
    """모든 직원 선택 해제"""
    selected_items = self.preview_tree.selection()
    if not selected_items:
        return
    
    # 모든 선택 해제
    for item in selected_items:
        self.preview_tree.selection_remove(item)
    
    # 선택 상태 업데이트
    self.on_selection_change()
    logger.info("전체 선택 해제")
```

#### 5.4 개별 선택 기능

- **기본 클릭**: 단일 항목 선택/해제 (기존 선택 해제됨)
- **Ctrl+클릭**: 다중 선택 (기존 선택 유지)
- **Shift+클릭**: 범위 선택 (첫 선택부터 현재까지)
- **드래그**: 범위 선택 (선택사항)

Treeview의 `selectmode='extended'` 설정으로 자동 지원됨.

---

## ⚠️ 주의사항

### 1. 선택 상태 유지
- 파일을 다시 로드할 때 선택 상태가 초기화됨
- 이는 의도된 동작 (새 파일 로드 시 선택 초기화)

### 2. 이름 중복 처리
- 이름이 중복될 경우 모두 처리됨
- 향후 주민번호나 고유 ID로 식별하는 방식 고려

### 3. 선택 해제 후 생성
- 선택을 해제하고 생성하면 전체 직원 처리
- 사용자에게 명확한 피드백 제공

### 4. 성능 고려
- 대량의 직원 데이터에서 선택 필터링 성능
- 현재는 작은 데이터셋이므로 문제 없음

---

## 📊 예상 작업 시간

| 단계 | 작업 내용 | 예상 시간 |
|------|----------|----------|
| 1 | Treeview 선택 모드 활성화 | 15분 |
| 2 | 선택된 직원 추적 메서드 구현 | 30분 |
| 3 | 급여명세서 생성 로직 수정 | 30분 |
| 4 | UI 개선 (선택 상태 표시, 전체 선택/해제 버튼) | 45분 |
| 5 | 테스트 (개별 선택, 다중 선택, 전체 선택/해제) | 40분 |
| 6 | 에러 처리 및 예외 상황 | 20분 |
| **총계** | | **3시간** |

---

## ✅ 체크리스트

### 구현 전
- [ ] 현재 상태 분석 완료
- [ ] 구현 계획 작성 완료

### 구현 중
- [ ] Treeview 선택 모드 활성화
- [ ] 선택된 직원 추적 메서드 구현
- [ ] 급여명세서 생성 로직 수정
- [ ] 선택 상태 표시 라벨 추가
- [ ] "전체 선택" 버튼 구현
- [ ] "전체 해제" 버튼 구현
- [ ] 개별 선택 기능 테스트
- [ ] 다중 선택 기능 테스트
- [ ] 전체 선택/해제 기능 테스트
- [ ] 선택 상태 실시간 업데이트 테스트
- [ ] 급여명세서 생성 테스트
- [ ] 에러 처리

### 구현 후
- [ ] 문서 업데이트
- [ ] 사용자 매뉴얼 업데이트

---

## 🔗 관련 파일

- `main.py` (수정 예정)
  - `create_payroll_tab()`: Treeview 설정 수정, 선택 버튼 및 상태 라벨 추가
  - `get_selected_employees()`: 신규 메서드 추가 (선택된 직원 이름 목록 반환)
  - `generate_payroll()`: 선택 필터링 로직 추가
  - `on_selection_change()`: 신규 메서드 추가 (선택 변경 시 상태 업데이트)
  - `select_all_employees()`: 신규 메서드 추가 (전체 선택 기능)
  - `deselect_all_employees()`: 신규 메서드 추가 (전체 해제 기능)

---

## 🚀 향후 개선 사항

1. **고유 ID 기반 선택**
   - 이름 대신 주민번호나 고유 ID로 식별
   - 이름 중복 문제 해결

2. **선택 저장 기능**
   - 선택된 직원 목록을 설정에 저장
   - 다음 실행 시 선택 상태 복원

3. **필터 기능**
   - 이름, 부서 등으로 필터링
   - 필터된 결과에서 선택

4. **일괄 선택 옵션**
   - 조건 기반 일괄 선택 (예: 정규직만 선택)
   - 정규식 기반 이름 필터

---

---

## 📌 사용자 시나리오

### 시나리오 1: 개별 선택
1. 사용자가 미리보기에서 특정 직원을 클릭
2. 해당 직원이 선택됨 (파란색으로 표시)
3. 선택 상태 라벨에 "선택된 직원: 1명 / 전체: 4명" 표시
4. "생성하기" 버튼 클릭
5. 선택된 1명의 급여명세서만 생성

### 시나리오 2: 다중 선택
1. 사용자가 첫 번째 직원 클릭
2. Ctrl 키를 누른 상태에서 두 번째, 세 번째 직원 클릭
3. 3명이 선택됨
4. 선택 상태 라벨에 "선택된 직원: 3명 / 전체: 4명" 표시
5. "생성하기" 버튼 클릭
6. 선택된 3명의 급여명세서만 생성

### 시나리오 3: 전체 선택
1. 사용자가 "전체 선택" 버튼 클릭
2. 모든 직원이 선택됨
3. 선택 상태 라벨에 "전체 선택됨 (4명)" 표시 (초록색)
4. "생성하기" 버튼 클릭
5. 선택된 4명의 급여명세서 생성

### 시나리오 4: 전체 해제 후 생성
1. 일부 직원이 선택된 상태
2. 사용자가 "전체 해제" 버튼 클릭
3. 모든 선택이 해제됨
4. 선택 상태 라벨에 "전체 직원 처리" 표시 (회색)
5. "생성하기" 버튼 클릭
6. 전체 직원의 급여명세서 생성 (기존 동작)

---

**마지막 업데이트**: 2025-11-11

