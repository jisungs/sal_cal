# 디자인 선택 기능 문제 분석

**작성일**: 2025-12-12  
**문제**: 웹 인터페이스에서 디자인을 선택해도 항상 기본 디자인으로 출력됨

---

## 문제 현상

- 웹 인터페이스에서 디자인 선택 (기본 디자인, 디자인 1, 디자인 2)
- 각각 선택하여 출력 진행
- 결과: 디자인의 변화 없음, 항상 기본 디자인으로 PDF 출력

---

## 코드 흐름 분석

### 1. 폼 제출 → 세션 저장

**파일**: `app/routes/payroll.py:63`

```python
session['design_name'] = form.design_name.data if hasattr(form, 'design_name') and form.design_name.data else None
```

**문제점**:
- `form.design_name.data`가 `'default'`일 때도 truthy이므로 저장됨
- 하지만 `'default'`는 기본 디자인을 의미하므로 `None`으로 변환해야 함

### 2. 다운로드 시 세션에서 가져오기

**파일**: `app/routes/main.py:249`

```python
design_name = session.get('design_name', None)
pdf_generator.generate_payslip(..., design_name=design_name)
```

**문제점**:
- `'default'`가 그대로 전달됨
- `None`으로 변환되지 않음

### 3. PDF 생성기에서 디자인 처리

**파일**: `payroll_generator/pdf_generator.py:61`

```python
if design_name:  # 'default'도 truthy이므로 실행됨
    design = DesignFactory.get_design(design_name)  # 'default' → None 반환
    if design:  # None이므로 False
        return design.generate_pdf(...)
# 기본 로직으로 넘어감
```

**문제점**:
- `'default'`가 truthy이므로 `if design_name:` 조건이 True가 됨
- `DesignFactory.get_design('default')`는 `None`을 반환
- `if design:` 조건이 False가 되어 기본 로직으로 넘어감
- 이것은 정상 동작이지만, 불필요한 호출이 발생

### 4. DesignFactory에서 'default' 처리

**파일**: `payroll_generator/templates/designs/design_factory.py:44`

```python
if design_name == 'default' or design_name is None:
    return None
```

**정상 동작**: `'default'`는 `None`을 반환하여 기본 방식 사용

---

## 근본 원인

**문제**: `'default'` 값이 `None`으로 변환되지 않고 그대로 전달됨

1. **세션 저장 시**: `'default'`가 그대로 저장됨
2. **다운로드 시**: `'default'`가 그대로 전달됨
3. **PDF 생성기**: `'default'`가 truthy이므로 불필요한 호출 발생

**하지만 실제 문제는**:
- 사용자가 'design_1'이나 'design_2'를 선택했을 때도 작동하지 않는다고 함
- 이는 다른 문제일 수 있음:
  - 폼에서 값이 제대로 전달되지 않음
  - 세션에 제대로 저장되지 않음
  - 세션에서 제대로 가져오지 못함

---

## 해결 방안

### 방안 1: 세션 저장 시 'default'를 None으로 변환 (권장)

**수정 위치**: `app/routes/payroll.py:63`

```python
# 변경 전
session['design_name'] = form.design_name.data if hasattr(form, 'design_name') and form.design_name.data else None

# 변경 후
design_name_value = form.design_name.data if hasattr(form, 'design_name') and form.design_name.data else None
session['design_name'] = design_name_value if design_name_value != 'default' else None
```

**장점**:
- 'default'를 명시적으로 None으로 변환
- 이후 로직에서 일관성 유지

### 방안 2: 다운로드 시 'default'를 None으로 변환

**수정 위치**: `app/routes/main.py:213, 249, 311`

```python
# 변경 전
design_name = session.get('design_name', None)

# 변경 후
design_name = session.get('design_name', None)
if design_name == 'default':
    design_name = None
```

**장점**:
- 다운로드 시점에 변환하여 일관성 유지

### 방안 3: PDF 생성기에서 'default' 처리

**수정 위치**: `payroll_generator/pdf_generator.py:61`

```python
# 변경 전
if design_name:

# 변경 후
if design_name and design_name != 'default':
```

**장점**:
- PDF 생성기에서 직접 처리
- 다른 호출 경로에서도 일관성 유지

---

## 권장 해결책

**방안 1 + 방안 2 조합을 권장합니다.**

이유:
1. 세션 저장 시점에 변환하여 데이터 일관성 유지
2. 다운로드 시점에도 변환하여 이중 체크
3. 모든 경로에서 일관된 동작 보장

---

## 추가 확인 사항

사용자가 'design_1'이나 'design_2'를 선택했을 때도 작동하지 않는다면:

1. **폼 필드 확인**: `input_form.html`에서 `name="design_name"`이 제대로 설정되어 있는지
2. **세션 확인**: 디버깅 로그로 세션에 값이 제대로 저장되는지 확인
3. **DesignFactory 확인**: `get_design('design_1')`이 제대로 인스턴스를 반환하는지

---

## 수정 코드

### 1. 세션 저장 시 'default'를 None으로 변환

```python
# app/routes/payroll.py:63
design_name_value = form.design_name.data if hasattr(form, 'design_name') and form.design_name.data else None
session['design_name'] = design_name_value if design_name_value != 'default' else None
```

### 2. 다운로드 시 'default'를 None으로 변환

```python
# app/routes/main.py:213, 249, 311
design_name = session.get('design_name', None)
if design_name == 'default':
    design_name = None
```

---

## 테스트 시나리오

수정 후 다음을 테스트해야 합니다:

1. **기본 디자인 선택**: 기본 디자인으로 출력되는지 확인
2. **디자인 1 선택**: 디자인 1 스타일로 출력되는지 확인
3. **디자인 2 선택**: 디자인 2 스타일로 출력되는지 확인
4. **세션 확인**: 각 선택 시 세션에 올바른 값이 저장되는지 확인
