# ✅ 반복 에러 수정 완료 보고서

**작성일**: 2025-12-11  
**에러**: `RuntimeError: Either 'SQLALCHEMY_DATABASE_URI' or 'SQLALCHEMY_BINDS' must be set.`  
**상태**: ✅ 수정 완료

---

## 🔍 근본 원인

**Python 클래스 속성은 모듈 로드 시점에 평가됩니다.**

테스트 파일 최상단의 `from config import`가 실행될 때:
- `config.py` 모듈이 로드됨
- `ProductionConfig.SQLALCHEMY_DATABASE_URI`가 평가됨
- 이 시점에 `DATABASE_URL` 환경 변수가 없으면 `None`으로 설정됨
- 이후 테스트 함수에서 환경 변수를 설정해도 이미 평가된 값은 변경되지 않음

---

## ✅ 적용된 수정 사항

### config.py 수정

**변경 전**:
```python
class ProductionConfig(Config):
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or \
        os.environ.get('POSTGRES_URL')  # 모듈 로드 시점에 평가
    
    @staticmethod
    def init_app(app):
        # SECRET_KEY만 동적 설정
        app.config['SECRET_KEY'] = secret_key
```

**변경 후**:
```python
class ProductionConfig(Config):
    SQLALCHEMY_DATABASE_URI = None  # 동적으로 설정
    
    @staticmethod
    def init_app(app):
        # SECRET_KEY 동적 설정
        app.config['SECRET_KEY'] = secret_key
        
        # SQLALCHEMY_DATABASE_URI 동적 설정 (추가)
        db_uri = os.environ.get('DATABASE_URL') or \
                 os.environ.get('POSTGRES_URL')
        if not db_uri:
            raise ValueError('DATABASE_URL이 필요합니다.')
        app.config['SQLALCHEMY_DATABASE_URI'] = db_uri
```

---

## 🎯 수정 효과

1. **런타임 환경 변수 확인**: 모듈 로드 시점이 아닌 앱 초기화 시점에 환경 변수 확인
2. **테스트 정상 작동**: 테스트에서 환경 변수 설정 후 정상 작동
3. **일관성 향상**: SECRET_KEY와 동일한 패턴으로 DATABASE_URI도 동적 설정
4. **프로덕션 보안 강화**: 필수 환경 변수 누락 시 명확한 에러 메시지

---

## 📋 수정된 파일

- ✅ `config.py`: `ProductionConfig.init_app()`에서 `SQLALCHEMY_DATABASE_URI` 동적 설정 추가

---

## 🧪 테스트 예상 결과

### 테스트 1: 개발 환경 설정
- ✅ 통과 예상

### 테스트 2: 프로덕션 환경 설정 (SECRET_KEY 없음)
- ✅ ValueError 발생 예상 (SECRET_KEY 누락)
- ⚠️ 주의: DATABASE_URL도 없으면 DATABASE_URL 에러가 먼저 발생할 수 있음
  - 테스트에서 DATABASE_URL도 설정 필요할 수 있음

### 테스트 3: 프로덕션 환경 설정 (SECRET_KEY 있음)
- ✅ 통과 예상 (DATABASE_URL 설정으로 정상 작동)

### 테스트 4: 세션 타임아웃 설정
- ✅ 통과 예상

---

## 📝 추가 고려 사항

### 테스트 2 수정 필요 여부

테스트 2는 SECRET_KEY 없이 ValueError를 발생시키는 테스트입니다. 이제 DATABASE_URL도 필수가 되었으므로:

**옵션 1**: 테스트 2에서 DATABASE_URL도 설정
- SECRET_KEY 검증에 집중
- DATABASE_URL은 테스트용 값 사용

**옵션 2**: 테스트 2에서 DATABASE_URL 없이도 SECRET_KEY 에러가 먼저 발생하도록 보장
- 현재 코드에서는 `init_app()`에서 SECRET_KEY를 먼저 확인하므로 SECRET_KEY 에러가 먼저 발생
- 하지만 DATABASE_URL도 없으면 DATABASE_URL 에러가 발생할 수 있음

**권장**: 테스트 2에서 DATABASE_URL도 설정하여 SECRET_KEY 검증에 집중

---

## ✅ 결론

**근본 원인을 해결했습니다.**

- `SQLALCHEMY_DATABASE_URI`를 `init_app()`에서 동적으로 설정하도록 수정
- SECRET_KEY와 일관된 패턴 유지
- 테스트에서 환경 변수 설정 후 정상 작동 예상

**다음 단계**: 테스트 재실행하여 모든 테스트 통과 확인

---

**작성자**: AI Assistant  
**작성일**: 2025-12-11  
**상태**: ✅ 수정 완료
