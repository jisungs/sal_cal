# 🔍 반복 에러 근본 원인 분석 보고서

**작성일**: 2025-12-11  
**에러**: `RuntimeError: Either 'SQLALCHEMY_DATABASE_URI' or 'SQLALCHEMY_BINDS' must be set.`  
**상태**: ✅ 근본 원인 발견, 해결 방안 제시

---

## 🔍 문제 상황

테스트에서 `DATABASE_URL` 환경 변수를 설정했음에도 불구하고 계속 같은 에러가 발생합니다.

---

## 📊 근본 원인 분석

### 문제의 핵심

**Python 클래스 속성은 모듈 로드 시점에 평가됩니다.**

### 상세 분석

1. **테스트 파일 구조**:
   ```python
   # tests/test_config.py (최상단)
   from config import config, DevelopmentConfig, ProductionConfig
   
   def test_production_config_with_secret_key():
       os.environ['DATABASE_URL'] = 'sqlite:///test_production.db'  # 여기서 설정
       from app import create_app
       app = create_app('production')  # 에러 발생
   ```

2. **모듈 로드 순서**:
   ```
   테스트 실행 시작
   ↓
   from config import ... 실행  ← config.py 모듈 로드
   ↓
   ProductionConfig 클래스 정의 평가
   ↓
   SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or ...
   ↓
   이 시점에 DATABASE_URL이 없음 → None으로 설정됨
   ↓
   (이후 환경 변수 변경해도 이미 평가된 값은 변경되지 않음)
   ↓
   테스트 함수 실행
   ↓
   os.environ['DATABASE_URL'] = '...' 설정
   ↓
   create_app('production') 호출
   ↓
   app.config.from_object(ProductionConfig) 실행
   ↓
   ProductionConfig.SQLALCHEMY_DATABASE_URI는 이미 None
   ↓
   db.init_app(app) 호출 시 에러 발생
   ```

3. **SECRET_KEY와의 차이점**:
   - `SECRET_KEY`는 `init_app()`에서 동적으로 설정하도록 수정했음 ✅
   - `SQLALCHEMY_DATABASE_URI`는 여전히 클래스 속성으로만 정의됨 ❌

---

## 💡 해결 방안

### 방안 1: init_app()에서 동적 설정 (권장) ⭐

`SECRET_KEY`와 동일한 방식으로 `SQLALCHEMY_DATABASE_URI`도 `init_app()`에서 동적으로 설정:

```python
class ProductionConfig(Config):
    SQLALCHEMY_DATABASE_URI = None  # 동적으로 설정
    
    @staticmethod
    def init_app(app):
        Config.init_app(app)
        
        # SECRET_KEY 설정
        secret_key = os.environ.get('SECRET_KEY')
        if not secret_key:
            raise ValueError('SECRET_KEY가 필요합니다.')
        app.config['SECRET_KEY'] = secret_key
        
        # SQLALCHEMY_DATABASE_URI 설정
        db_uri = os.environ.get('DATABASE_URL') or \
                 os.environ.get('POSTGRES_URL')
        if not db_uri:
            raise ValueError('DATABASE_URL이 필요합니다.')
        app.config['SQLALCHEMY_DATABASE_URI'] = db_uri
```

**장점**:
- SECRET_KEY와 일관된 패턴
- 런타임에 환경 변수 확인 가능
- 테스트에서 환경 변수 설정 후에도 정상 작동

**단점**:
- 프로덕션 환경에서 DATABASE_URL이 없으면 앱 시작 시 에러 발생 (의도된 동작)

### 방안 2: 테스트에서 import 순서 변경

테스트 함수 내부에서 import:

```python
def test_production_config_with_secret_key():
    os.environ['DATABASE_URL'] = 'sqlite:///test_production.db'
    os.environ['SECRET_KEY'] = 'test-secret'
    
    # 환경 변수 설정 후 import
    from app import create_app
    app = create_app('production')
```

**단점**:
- 테스트 파일 최상단의 `from config import`와 충돌 가능
- 다른 테스트에 영향을 줄 수 있음

### 방안 3: 모듈 리로드

테스트에서 모듈을 리로드:

```python
import importlib
os.environ['DATABASE_URL'] = 'sqlite:///test_production.db'
importlib.reload(config)
```

**단점**:
- 복잡하고 부작용이 많음
- 권장하지 않음

---

## 🎯 권장 해결 방법

**방안 1 (init_app()에서 동적 설정)**을 권장합니다.

이유:
1. SECRET_KEY와 일관된 패턴 유지
2. 프로덕션 환경에서 필수 환경 변수 검증 가능
3. 테스트에서도 정상 작동
4. 코드 일관성 향상

---

## 📝 수정 제안

### config.py 수정

```python
class ProductionConfig(Config):
    """프로덕션 환경 설정"""
    DEBUG = False
    TESTING = False
    
    # 프로덕션 환경에서는 PostgreSQL 사용 (Railway)
    # SQLALCHEMY_DATABASE_URI는 init_app()에서 동적으로 설정
    SQLALCHEMY_DATABASE_URI = None
    
    # 보안 강화: 프로덕션 환경에서는 SECRET_KEY 필수
    SECRET_KEY = None  # init_app()에서 동적으로 설정
    
    @staticmethod
    def init_app(app):
        """애플리케이션 초기화 - SECRET_KEY 및 DATABASE_URI 동적 설정"""
        Config.init_app(app)
        
        # SECRET_KEY 설정
        secret_key = os.environ.get('SECRET_KEY')
        if not secret_key:
            raise ValueError(
                '프로덕션 환경에서는 SECRET_KEY 환경 변수가 반드시 설정되어야 합니다. '
                '환경 변수를 설정하거나 .env 파일을 확인하세요.'
            )
        app.config['SECRET_KEY'] = secret_key
        
        # SQLALCHEMY_DATABASE_URI 설정
        db_uri = os.environ.get('DATABASE_URL') or \
                 os.environ.get('POSTGRES_URL')
        if not db_uri:
            raise ValueError(
                '프로덕션 환경에서는 DATABASE_URL 환경 변수가 반드시 설정되어야 합니다. '
                '환경 변수를 설정하거나 .env 파일을 확인하세요.'
            )
        app.config['SQLALCHEMY_DATABASE_URI'] = db_uri
```

---

## ✅ 예상 효과

수정 후:
1. 테스트에서 환경 변수 설정 후 정상 작동
2. 프로덕션 환경에서 필수 환경 변수 검증 강화
3. SECRET_KEY와 일관된 패턴 유지
4. 모든 테스트 통과 예상

---

**작성자**: AI Assistant  
**작성일**: 2025-12-11  
**상태**: ✅ 근본 원인 분석 완료, 해결 방안 제시
