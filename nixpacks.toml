# Nixpacks 설정 파일 - Railway 빌드 설정
# LibreOffice 및 한글 폰트 설치를 위한 설정

# Nixpacks는 Nix 패키지 매니저를 사용하므로 python3Packages.pip를 명시적으로 추가해야 함
# apt-get으로 설치한 python3-pip는 Nix Python 환경에 연결되지 않음
[phases.setup]
nixPkgs = ["libreoffice", "python3", "python3Packages.pip"]

[phases.install]
cmds = [
  "apt-get update && apt-get install -y libreoffice libreoffice-writer libreoffice-calc libreoffice-impress fonts-nanum fonts-nanum-coding fontconfig || true",
  "mkdir -p /usr/share/fonts/truetype/nanum ~/.fonts /usr/share/fonts/opentype",
  "cp payroll_generator/assets/NanumGothic.ttf /usr/share/fonts/truetype/nanum/ 2>/dev/null || cp 'payroll_generator/assets/나눔 글꼴/나눔고딕/NanumFontSetup_TTF_GOTHIC/NanumGothic.ttf' /usr/share/fonts/truetype/nanum/ 2>/dev/null || true",
  "cp payroll_generator/assets/NanumGothic.ttf ~/.fonts/ 2>/dev/null || cp 'payroll_generator/assets/나눔 글꼴/나눔고딕/NanumFontSetup_TTF_GOTHIC/NanumGothic.ttf' ~/.fonts/ 2>/dev/null || true",
  "fc-cache -fv --force",
  "fc-list | grep -i nanum || echo '폰트 확인 중...'"
]

# Python 패키지 설치는 [phases.build]에서 명시적으로 처리
# nixpacks.toml에 커스텀 설정이 있으면 자동 빌드가 실행되지 않을 수 있으므로
# 명시적으로 Python 패키지를 설치해야 합니다
# python3Packages.pip가 제대로 작동하지 않을 수 있으므로 ensurepip로 pip를 먼저 설치
[phases.build]
cmds = [
  "python3 -m ensurepip --upgrade --default-pip || curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py && python3 get-pip.py",
  "python3 -m pip install --upgrade pip",
  "python3 -m pip install -r requirements.txt"
]

